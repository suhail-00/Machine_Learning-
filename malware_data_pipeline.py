import pandas as pd
import requests
import sys
from urllib.error import HTTPError

def run_complete_malware_pipeline():
    """
    Downloads recent MalwareBazaar data, cleans structure/headers,
    labels the data based on 'tags', and saves the final clean CSV.
    """
    
    DATA_URL = "https://bazaar.abuse.ch/export/csv/recent/"
    OUTPUT_CLEANED_FILE = "malware_data_final.csv"
    
    # --- CRITICAL: Placeholder for the LABEL column ---
    # We will try 'tags' first, but be prepared to change this based on final inspection.
    # Note: We use the cleaned name here, which means we must find the raw name later.
    TARGET_COLUMN_CLEAN_NAME = 'iMobile Lite (2).apk' 
    
    print("=" * 50)
    print(" COMPLETE MALWARE DATA PIPELINE (FINAL FIX) ")
    print("=" * 50)
    print(f"[*] Phase 1: Attempting to download data from: {DATA_URL}")

    try:
        # --- PHASE 1: Data Collection & Robust Reading ---
        df = pd.read_csv(
            DATA_URL,
            comment='#',
            sep=',',
            engine='python',
            on_bad_lines='skip',
            encoding='latin-1',
            header=0  # Treat the first row as the header
        )

        print(f"[+] Phase 1 COMPLETE. Raw data loaded with shape: {df.shape}")

        # *** NEW CRITICAL STEP: Clean up column names ***
        print("[*] Cleaning column names (removing quotes/whitespace)...")
        df.columns = df.columns.str.strip().str.replace('"', '')
        print(f"[+] Cleaned column names: {df.columns.tolist()}")
        # ------------------------------------------------

        # --- PHASE 2: Data Cleaning & Labeling ---
        print("\n[*] Phase 2: Starting cleaning and labeling...")
        
        # 2.1 Drop Duplicates
        initial_duplicates = df.duplicated().sum()
        df.drop_duplicates(inplace=True)
        print(f"[+] Duplicates removed: {initial_duplicates}")
        
        # 2.2 Drop known junk/metadata columns
        cols_to_drop = ['reporter', 'source', 'url', 'comment', 'ssdeep', 'sha1', 'md5'] 
        df.drop(columns=[col for col in cols_to_drop if col in df.columns], inplace=True, errors='ignore')
        
        # 2.3 Target Label Handling - Now using the CLEANED name
        print(f"[*] Target Column identified as: '{TARGET_COLUMN_CLEAN_NAME}'")
        
        initial_rows = len(df)
        
        # Drop rows where the label is missing
        df.dropna(subset=[TARGET_COLUMN_CLEAN_NAME], inplace=True)
        rows_dropped = initial_rows - len(df)
        print(f"[+] Rows dropped due to missing label: {rows_dropped}")
        
        # Clean the label column (lowercase and strip whitespace)
        df[TARGET_COLUMN_CLEAN_NAME] = df[TARGET_COLUMN_CLEAN_NAME].astype(str).str.lower().str.strip()

        # Rename the target column to a clean standard name for the ML team
        df.rename(columns={TARGET_COLUMN_CLEAN_NAME: 'malware_family'}, inplace=True)
        
        # --- PHASE 3: Saving the Final Dataset ---
        print(f"\n[*] Phase 3: Saving final clean data to {OUTPUT_CLEANED_FILE}...")
        df.to_csv(OUTPUT_CLEANED_FILE, index=False)
        
        print("\n--- FINAL SUMMARY ---")
        print(f"[SUCCESS] Pipeline complete. Final dataset shape: {df.shape}")
        print(f"Final Family Distribution:\n{df['malware_family'].value_counts().head(5)}")
        print(f"File saved as: {OUTPUT_CLEANED_FILE}")
        
    except (requests.exceptions.RequestException, HTTPError) as e:
        print(f"[-] A Network/HTTP error occurred: {e}")
        print("[ERROR] Failed to connect to the data source.")

    except KeyError as e:
        print(f"[-] A column error occurred: Column {e} was not found.")
        print("[CRITICAL ACTION] Check the value assigned to 'TARGET_COLUMN_CLEAN_NAME' in the script. If 'tags' failed again, try 'alias' or check the cleaned column list printed below!")
        # Print columns again if KeyError happens so you can easily see the actual names
        if 'df' in locals() and isinstance(df, pd.DataFrame):
             print(f"Available Cleaned Columns: {df.columns.tolist()}")
    
    except Exception as e:
        print(f"[-] An unexpected error occurred during processing: {e}")
        print("[ERROR] Pipeline failed unexpectedly.")

    print("=" * 50)


if __name__ == "__main__":
    run_complete_malware_pipeline()